---
import type { HTMLAttributes } from 'astro/types';

export type Props = HTMLAttributes<'div'> & {
    position?:
        | 'top-left'
        | 'top-right'
        | 'top-center'
        | 'center-right'
        | 'bottom-left'
        | 'bottom-right'
        | 'bottom-center';
};

const { position = 'bottom-center', ...props } = Astro.props;
---

<div class:list={['dropdown js-dropdown', props.class]} {...props}>
    <slot name="trigger" />
    <div class:list={['dropdown-content js-dropdown-content', position]}>
        <slot />
    </div>
</div>

<style lang="scss">
    @use '@/app/css/base/variables' as *;
    @use '@/app/css/utils/mixins' as *;

    .dropdown {
        position: relative;
        display: flex;
        width: max-content;
        max-width: 100%;

        &.dropdown--opened {
            .dropdown-content {
                z-index: 3;
                opacity: 1;
                visibility: visible;
            }
        }
    }

    .dropdown-toggler {
        cursor: pointer;
    }

    .dropdown-content {
        position: absolute;
        z-index: 2;
        max-width: 100vw;
        width: max-content;
        opacity: 0;
        visibility: hidden;
        transition:
            opacity 0.3s ease,
            visibility 0.3s ease,
            transform 0.3s $app-default-easing;
        max-height: min(500px, calc(100vh - var(--header-height)));
        overflow-y: auto;

        &.bottom-left {
            top: 100%;
            left: 0;
        }

        &.bottom-center {
            top: 100%;
            left: 50%;
            transform: translate(-50%, 0);
        }

        &.bottom-right {
            top: 100%;
            right: 0;
        }

        &.top-left {
            bottom: 100%;
            left: 0;
        }

        &.top-right {
            bottom: 100%;
            right: 0;
        }

        &.top-center {
            bottom: 100%;
            left: 50%;
            transform: translate(-50%, 0);
        }

        &.center-right {
            bottom: 50%;
            right: 0;
        }
    }
</style>

<script>
    import delegate from 'delegate';
    import { onOutsideClickAction } from '@/shared/lib/on-outside-click-action';

    const ACTIVE_CLASS = 'dropdown--opened';

    delegate(document, '.js-dropdown-toggler', 'click', (event: any) => {
        const target = event.delegateTarget as HTMLElement;
        const dropdownEl = target.closest<HTMLElement>('.js-dropdown');

        if (dropdownEl) {
            dropdownEl.classList.toggle(ACTIVE_CLASS);
        }
    });

    Array.from(document.querySelectorAll('.js-dropdown')).forEach((dropdownEl) => {
        onOutsideClickAction(dropdownEl, () => {
            if (dropdownEl) {
                dropdownEl.classList.remove(ACTIVE_CLASS);
            }
        });
    });
</script>
